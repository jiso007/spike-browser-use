# LLM Message Preparation Locations

This document outlines where the different components of the message list sent to the LLM (System Prompt, Initial Task, Current Browser State) are prepared within the `browser-use` codebase.

The preparation primarily occurs within the `MessageManager` class, orchestrated by the `Agent` class methods.

## 1. System Prompt and Initial Task Setup

*   **When:** During the initialization of the `Agent` object.
*   **Where:** `browser_use/agent/service.py`, inside the `Agent.__init__` method.
*   **How:** The `task` string and a formatted system prompt (generated by `SystemPrompt` class, likely in `browser_use/agent/prompts.py`) are passed to the `MessageManager` constructor.
*   **Code Snippet (approx. Lines 210-223 in `agent/service.py`):
    ```python
    # browser_use/agent/service.py Agent.__init__
    self._message_manager = MessageManager(
        task=task, # Initial task passed here
        system_message=SystemPrompt(
            # ... configuration ...
        ).get_system_message(), # Formatted system instructions
        settings=MessageManagerSettings(
            # ... settings ...
        ),
        state=self.state.message_manager_state,
    )
    # MessageManager.__init__ adds these as the initial messages.
    ```

## 2. Adding the Current Browser State

*   **When:** At the beginning of each execution cycle within `Agent.step()`.
*   **Where:** `browser_use/agent/service.py`, inside the `Agent.step` method.
*   **How:** The `BrowserState` object (retrieved by `BrowserContext.get_state()`) is passed to the `MessageManager.add_state_message` method, which formats it (text, possibly image) and appends it to the message history.
*   **Code Snippet (approx. Line 417 in `agent/service.py`):
    ```python
    # browser_use/agent/service.py Agent.step
    # state = await self.browser_context.get_state(...)
    self._message_manager.add_state_message(state, self.state.last_result, step_info, self.settings.use_vision)
    ```

## 3. Retrieving Prepared Messages for LLM Call

*   **When:** Immediately before the LLM is called within `Agent.step()`.
*   **Where:** `browser_use/agent/service.py`, inside the `Agent.step` method.
*   **How:** The `MessageManager.get_messages()` method is called to retrieve the complete, ordered list of messages (System, Human, AI, State) that have been prepared.
*   **Code Snippet (approx. Line 448 in `agent/service.py`):
    ```python
    # browser_use/agent/service.py Agent.step
    input_messages = self._message_manager.get_messages()
    # ...
    model_output = await self.get_next_action(input_messages) # Prepared messages sent here
    ```

**In Summary:** The `MessageManager` acts as the central hub for constructing the conversation history sent to the LLM. It's initialized with the static components (system prompt, task) and dynamically updated with the current browser state in each step before the full message list is retrieved and passed to the LLM via `Agent.get_next_action()`. 